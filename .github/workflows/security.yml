name: Security Pipeline - NotesApp

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  security-checks:
    runs-on: ubuntu-latest
    
    steps:
    # 1. –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    # 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    - name: Install security tools
      run: |
        pip install bandit safety
        
    # 4. –ó–∞–ø—É—Å–∫ Bandit (SAST)
    - name: Run Bandit SAST scan
      id: bandit
      run: |
        echo "üöÄ Running Bandit security scan..."
        bandit -r . \
          -f json \
          -o bandit_report.json \
          --exit-zero
        
        # –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        if python -c "
import json
with open('bandit_report.json') as f:
    data = json.load(f)
high = [i for i in data['results'] if i['issue_severity'] == 'HIGH']
if high:
    print(f'‚ùå Found {len(high)} HIGH severity vulnerabilities!')
    print('::error::High severity vulnerabilities found. Blocking merge.')
    exit(1)
else:
    print('‚úÖ No HIGH severity vulnerabilities found.')
        "; then
          echo "Bandit check passed"
        else
          exit 1
        fi
        
    # 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    - name: Check dependencies with safety
      run: |
        echo "üì¶ Checking dependencies for vulnerabilities..."
        if [ -f requirements.txt ]; then
          safety check -r requirements.txt || echo "Warning: safety check failed"
        else
          echo "No requirements.txt found"
        fi
        
    # 6. Security Gate - –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–∞—Å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    - name: Security Gate - Block dangerous code
      id: security-gate
      run: |
        echo "üöß Checking for security violations..."
        
        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –ë–õ–û–ö–ò–†–£–Æ–¢ –º–µ—Ä–∂
        VIOLATIONS=0
        
        # 1. Debug mode –≤ production
        if grep -r "\.debug\s*=\s*True" . --include="*.py" --exclude-dir=.github; then
          echo "‚ùå CRITICAL: Found .debug = True"
          VIOLATIONS=$((VIOLATIONS + 1))
        fi
        
        # 2. Flask app.run(debug=True)
        if grep -r "\.run.*debug\s*=\s*True" . --include="*.py" --exclude-dir=.github; then
          echo "‚ùå CRITICAL: Found Flask debug mode"
          VIOLATIONS=$((VIOLATIONS + 1))
        fi
        
        # 3. Hardcoded secrets (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ)
        echo "üîç Checking for hardcoded secrets..."
        grep -r "SECRET_KEY\s*=\s*['\"].*['\"]" . --include="*.py" || true
        grep -r "password\s*=\s*['\"].*['\"]" . --include="*.py" || true
        
        # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        if [ $VIOLATIONS -gt 0 ]; then
          echo "::error::Found $VIOLATIONS critical security violations"
          echo "üö´ MERGE BLOCKED - Security violations detected"
          exit 1
        else
          echo "‚úÖ Security gate passed - No critical violations found"
        fi
        
    # 7. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
    - name: Success notification
      if: success()
      run: |
        echo "üéâ All security checks passed!"
        echo "‚úÖ SAST: Passed"
        echo "‚úÖ Dependencies: Checked"
        echo "‚úÖ Security gate: Passed"
        echo "‚úÖ Ready for merge"