name: Security Pipeline - NotesApp

on:
  push:
    branches: [main]

jobs:
  security-checks:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install security tools
        run: pip install bandit
      
      - name: Run Bandit SAST scan
        run: |
          echo "Running Bandit security scan..."
          bandit -r . --format txt
          echo "‚úÖ Bandit scan completed"
      
      - name: Security Gate - Check for debug=True
        id: security-gate
        run: |
          echo "Checking for security violations..."
          
          VIOLATIONS=0
          
          # –ü–æ–∏—Å–∫ debug=True –≤ Python —Ñ–∞–π–ª–∞—Ö
          if grep -r "\.debug\s*=\s*True" . --include="*.py"; then
            echo "‚ùå CRITICAL: Found .debug = True"
            VIOLATIONS=1
          fi
          
          if grep -r "\.run.*debug\s*=\s*True" . --include="*.py"; then
            echo "‚ùå CRITICAL: Found Flask debug mode"
            VIOLATIONS=1
          fi
          
          # –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –Ω–∞—Ä—É—à–µ–Ω–∏—è - –±–ª–æ–∫–∏—Ä—É–µ–º
          if [ $VIOLATIONS -gt 0 ]; then
            echo "::error::Found $VIOLATIONS critical security violations"
            echo "üö´ MERGE BLOCKED - Security violations detected"
            exit 1
          else
            echo "‚úÖ Security gate passed - No critical violations found"
          fi
      
      - name: Success
        if: success()
        run: echo "üéâ All security checks passed!"
